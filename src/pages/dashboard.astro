---
import AppLayout from "../layouts/AppLayout.astro";
import Icon from "../components/Icon.astro";
import AddFeedModal from "../components/AddFeedModal.astro";
import FeedActionsMenu from "../components/FeedActionsMenu.astro";
---

<AppLayout title="Dashboard - Frontpage">
    <div class="mt-25 pl-10">
        <h1 class="text-6xl font-serif text-text-primary">News</h1>
    </div>

    <!-- Subscriptions filter tabs -->
    <div class="flex items-center gap-6 pb-4 pl-10">
        <span class="text-xs font-mono uppercase text-text-secondary opacity-60"
            >Favorites</span
        >
        <div id="subs-tabs" class="flex items-center gap-6">
            <button
                class="tab-btn text-xl font-medium text-text-primary border-b-[3px] border-text-primary pb-1"
                data-url="all">All</button
            >
            <!-- Dynamic favorite tabs will be injected here -->
        </div>

        <div class="ml-auto pr-10">
            <FeedActionsMenu />
        </div>
    </div>

    <!-- Thick horizontal line under tabs -->
    <div class="h-[3px] bg-text-primary mb-0"></div>

    <!-- 3-Column News Grid -->
    <div
        id="news-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 min-h-[400px] view-cards"
    >
        <div
            class="col-span-full flex items-center justify-center p-20 text-text-secondary opacity-50"
        >
            <div class="flex flex-col items-center gap-4">
                <div
                    class="animate-spin rounded-full h-8 w-8 border-b-2 border-text-primary"
                >
                </div>
                <p class="font-mono text-sm uppercase tracking-widest">
                    Loading news...
                </p>
            </div>
        </div>
    </div>

    <AddFeedModal />
    <button id="logout-btn" class="hidden">Sign Out</button>
</AppLayout>

<script>
    import { supabase } from "../lib/supabase";

    const subsContainer = document.getElementById("subs-tabs");
    const newsGrid = document.getElementById("news-grid");
    const userInfo = document.querySelector("#user-info") as HTMLElement;

    let currentSession: any = null;
    let subscriptions: any[] = [];
    let currentFeedUrl: string = "all";
    let viewMode: string = "cards"; // cards, list, compact
    let userBookmarks: Set<string> = new Set();

    async function init() {
        const {
            data: { session },
        } = await supabase.auth.getSession();
        if (!session) {
            window.location.href = "/login";
            return;
        }
        currentSession = session;

        if (userInfo && session.user.email)
            userInfo.textContent = session.user.email;
        // Load bookmarks in background (non-blocking)
        loadUserBookmarks().catch(() => {});
        await loadSubscriptions();
        await loadFeed("all", "All Subscriptions");
    }

    async function loadUserBookmarks() {
        try {
            const res = await fetch("/api/bookmarks/list", {
                headers: {
                    Authorization: `Bearer ${currentSession.access_token}`,
                },
            });
            const data = await res.json();
            if (Array.isArray(data)) {
                userBookmarks = new Set(data.map((item: any) => item.guid));
            }
        } catch (err) {
            console.error("Failed to load bookmarks", err);
        }
    }

    async function loadSubscriptions() {
        try {
            const response = await fetch("/api/feeds/list", {
                headers: {
                    Authorization: `Bearer ${currentSession.access_token}`,
                },
            });
            subscriptions = await response.json();
            renderFavoriteTabs();
        } catch (err) {
            console.error("Failed to load subs", err);
        }
    }

    function renderFavoriteTabs() {
        if (!subsContainer) return;

        subsContainer.innerHTML = "";

        // Always recreate the All button
        const allBtn = document.createElement("button");
        allBtn.className =
            "tab-btn text-xl font-medium text-text-primary border-b-[3px] border-text-primary pb-1";
        allBtn.textContent = "All";
        allBtn.dataset.url = "all";
        allBtn.addEventListener("click", () => {
            loadFeed("all", "All Subscriptions");
        });
        subsContainer.appendChild(allBtn);

        // Only show top 3 favorites
        const favorites = subscriptions
            .filter((s) => s.is_favorite)
            .slice(0, 3);

        favorites.forEach((sub) => {
            const btn = document.createElement("button");
            const title = sub.custom_title || sub.feeds.title;
            btn.className =
                "tab-btn text-xl font-medium text-text-secondary hover:text-text-primary transition-colors pb-1 relative";
            btn.textContent = title;
            btn.dataset.url = sub.feeds.url;

            btn.addEventListener("click", () => {
                loadFeed(sub.feeds.url, title, sub.id);
            });

            subsContainer.appendChild(btn);
        });
    }

    async function loadFeed(
        url: string,
        title: string,
        subscriptionId?: string,
    ) {
        if (!newsGrid) return;
        currentFeedUrl = url;
        updateTabsUI(url);

        // Mark as read if subscription ID is present
        if (subscriptionId) {
            try {
                fetch("/api/feeds/mark-read", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${currentSession.access_token}`,
                    },
                    body: JSON.stringify({ subscriptionId }),
                });
                window.dispatchEvent(new CustomEvent("unread-counts-changed"));
            } catch (err) {
                console.error(err);
            }
        }

        newsGrid.innerHTML = `
            <div class="col-span-full flex items-center justify-center p-20 text-text-secondary opacity-50">
                <div class="flex flex-col items-center gap-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-text-primary"></div>
                    <p class="font-mono text-sm uppercase tracking-widest">Fetching ${title}...</p>
                </div>
            </div>
        `;

        try {
            const response = await fetch(
                `/api/feeds/content?url=${encodeURIComponent(url)}`,
                {
                    headers: {
                        Authorization: `Bearer ${currentSession.access_token}`,
                    },
                },
            );
            const feed = await response.json();
            renderNews(feed, url);
        } catch (err) {
            newsGrid.innerHTML = `<div class="col-span-full p-12 text-center text-red-500">Failed to load content for ${title}</div>`;
        }
    }

    function renderNews(feed: any, feedUrl: string) {
        if (!newsGrid) return;

        if (!feed.items || feed.items.length === 0) {
            newsGrid.innerHTML = `<div class="col-span-full p-20 text-center text-text-secondary">No articles found in this feed.</div>`;
            return;
        }

        newsGrid.innerHTML = feed.items
            .map((item: any) => {
                const itemFeedUrl =
                    feedUrl === "all" ? item.feedUrl || "" : feedUrl;
                const isBookmarked = userBookmarks.has(item.guid);

                return `
            <div 
                class="news-card group flex flex-col no-underline border-b-[3px] border-text-primary border-r-[3px] nth-[3n]:border-r-0 relative"
                data-guid="${item.guid}"
            >
                <a href="/preview?url=${encodeURIComponent(item.link)}&feedUrl=${encodeURIComponent(itemFeedUrl)}" class="flex flex-col flex-1 no-underline">
                    <div class="card-image-container p-5 pb-0">
                        <div class="aspect-16/10 overflow-hidden bg-bg-secondary rounded-sm">
                            <img 
                                src="${item.imageUrl || `https://placehold.co/600x375/cec7c0/2e2522?text=${encodeURIComponent(item.title)}&font=serif`}" 
                                alt="${item.title}" 
                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                loading="lazy"
                            />
                        </div>
                    </div>
                    <div class="p-5 pt-4 flex flex-col flex-1">
                        <h2 class="card-title text-xl font-serif font-bold text-text-primary leading-snug mb-4 group-hover:opacity-70 transition-opacity line-clamp-3">
                            ${item.title}
                        </h2>
                        <div class="card-meta flex items-center justify-between text-sm text-text-secondary mt-auto">
                            <div class="flex items-center gap-2">
                                <span class="font-medium text-text-primary text-sm">${item.feedTitle || feed.title || "Feed"}</span>
                                <span class="text-sm">▪</span>
                                <time class="text-sm">${new Date(item.pubDate).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" })}</time>
                            </div>
                        </div>
                    </div>
                </a>
                
                <!-- Action buttons -->
                <div class="card-actions flex flex-col absolute top-4 right-4 gap-1 z-10">
                    <a href="${item.link}" target="_blank" rel="noopener" class="action-btn w-7 h-7 flex items-center justify-center rounded-full border border-text-secondary/30 text-text-secondary hover:border-text-primary hover:text-text-primary transition-colors text-xs bg-bg-primary/80 backdrop-blur-sm no-underline">↗</a>
                    <button 
                        class="bookmark-btn action-btn w-7 h-7 flex items-center justify-center rounded-full bg-bg-primary/80 backdrop-blur-sm border border-text-primary/10 text-text-secondary hover:text-text-primary hover:border-text-primary/30 transition-all"
                        title="${isBookmarked ? "Remove bookmark" : "Bookmark for later"}"
                        data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}'
                        data-feed-url="${itemFeedUrl}"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="${isBookmarked ? "currentColor" : "none"}" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
            })
            .join("");

        // Add event listeners for bookmark buttons
        document.querySelectorAll(".bookmark-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                e.stopPropagation();

                const b = e.currentTarget as HTMLButtonElement;
                const itemData = JSON.parse(b.dataset.item || "{}");
                const feedUrl = b.dataset.feedUrl;

                // Optimistic UI
                const svg = b.querySelector("svg");
                const isCurrentlySaved = svg?.getAttribute("fill") !== "none";
                if (svg)
                    svg.setAttribute(
                        "fill",
                        isCurrentlySaved ? "none" : "currentColor",
                    );

                try {
                    const res = await fetch("/api/bookmarks/toggle", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${currentSession.access_token}`,
                        },
                        body: JSON.stringify({ item: itemData, feedUrl }),
                    });
                    const result = await res.json();

                    if (result.is_saved) {
                        userBookmarks.add(itemData.guid);
                        if (svg) svg.setAttribute("fill", "currentColor");
                        b.title = "Remove bookmark";
                    } else {
                        userBookmarks.delete(itemData.guid);
                        if (svg) svg.setAttribute("fill", "none");
                        b.title = "Bookmark for later";
                    }
                } catch (err) {
                    console.error("Bookmark toggle failed", err);
                    // Rollback
                    if (svg)
                        svg.setAttribute(
                            "fill",
                            isCurrentlySaved ? "currentColor" : "none",
                        );
                }
            });
        });
    }

    function updateTabsUI(activeUrl: string) {
        const btns = document.querySelectorAll(".tab-btn");
        btns.forEach((btn) => {
            if ((btn as HTMLElement).dataset.url === activeUrl) {
                btn.classList.remove("text-text-secondary");
                btn.classList.add(
                    "text-text-primary",
                    "border-b-[3px]",
                    "border-text-primary",
                );
            } else {
                btn.classList.remove(
                    "text-text-primary",
                    "border-b-[3px]",
                    "border-text-primary",
                );
                btn.classList.add("text-text-secondary");
            }
        });
    }

    // --- Event Listeners ---

    window.addEventListener("feed-added", () => {
        loadSubscriptions();
    });

    window.addEventListener("feed-favorite-toggled", () => {
        loadSubscriptions();
    });

    window.addEventListener("select-feed", (e: any) => {
        const { url, title, subscriptionId } = e.detail;
        loadFeed(url, title, subscriptionId);
    });

    window.addEventListener("feed-action", (e: any) => {
        const { action } = e.detail;
        if (action === "refresh") {
            loadFeed(currentFeedUrl, "Refreshing...");
        } else if (action.startsWith("view-")) {
            const mode = action.replace("view-", "");
            setViewMode(mode);
        }
    });

    function setViewMode(mode: string) {
        viewMode = mode;
        newsGrid?.classList.remove("view-cards", "view-list", "view-compact");
        newsGrid?.classList.add(`view-${mode}`);

        if (mode === "list") {
            newsGrid?.classList.remove(
                "grid-cols-1",
                "md:grid-cols-2",
                "lg:grid-cols-3",
            );
            newsGrid?.classList.add("grid-cols-1");
        } else if (mode === "cards") {
            newsGrid?.classList.add(
                "grid-cols-1",
                "md:grid-cols-2",
                "lg:grid-cols-3",
            );
            newsGrid?.classList.remove("grid-cols-1");
        }
    }

    // Start
    init();
</script>

<style is:global>
    /* View Mode: List */
    .view-list {
        display: flex !important;
        flex-direction: column !important;
        grid-template-columns: none !important;
    }
    .view-list .news-card {
        flex-direction: row !important;
        min-height: 100px;
        max-height: 120px;
        border-right: none !important;
        overflow: hidden;
    }
    .view-list .news-card > a {
        flex-direction: row !important;
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }
    .view-list .card-image-container {
        width: 160px;
        min-width: 160px;
        max-width: 160px;
        padding: 10px !important;
        flex-shrink: 0;
    }
    .view-list .card-image-container > div {
        aspect-ratio: auto !important;
        height: 100%;
    }
    .view-list .news-card > a > div:last-child {
        flex: 1;
        min-width: 0;
        padding: 10px 12px !important;
        overflow: hidden;
    }
    .view-list .card-title {
        font-size: 0.95rem;
        margin-bottom: 4px !important;
        -webkit-line-clamp: 2;
    }
    /* Actions in list: flex row, positioned at end of card */
    .view-list .card-actions {
        position: relative !important;
        top: auto !important;
        right: auto !important;
        flex-direction: row !important;
        align-items: center;
        align-self: center;
        gap: 10px;
        padding-right: 12px;
        margin-left: 12px;
        flex-shrink: 0;
    }

    /* View Mode: Compact */
    .view-compact {
        display: flex !important;
        flex-direction: column !important;
        grid-template-columns: none !important;
    }
    .view-compact .news-card {
        flex-direction: row !important;
        align-items: center;
        border-right: none !important;
        padding: 6px 16px;
        min-height: auto;
    }
    .view-compact .news-card > a {
        flex-direction: row !important;
        flex: 1;
        min-width: 0;
        align-items: center;
        gap: 12px;
    }
    .view-compact .card-image-container {
        display: none !important;
    }
    .view-compact .news-card > a > div:last-child {
        flex: 1;
        min-width: 0;
        padding: 4px 0 !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: center;
        gap: 12px;
    }
    .view-compact .card-title {
        font-size: 0.875rem;
        margin-bottom: 0 !important;
        flex: 1;
        min-width: 0;
        -webkit-line-clamp: 1;
    }
    .view-compact .card-meta {
        flex-shrink: 0;
        margin-top: 0 !important;
    }
    /* Actions in compact: flex row, positioned at end of card */
    .view-compact .card-actions {
        position: relative !important;
        top: auto !important;
        right: auto !important;
        flex-direction: row !important;
        align-items: center;
        align-self: center;
        gap: 10px;
        padding-right: 8px;
        margin-left: 16px;
        flex-shrink: 0;
    }
</style>
