---
import AppLayout from "../layouts/AppLayout.astro";
import Icon from "../components/Icon.astro";
import AddFeedModal from "../components/AddFeedModal.astro";
import FeedActionsMenu from "../components/FeedActionsMenu.astro";
import DashboardEmptyState from "../components/DashboardEmptyState.astro";
import { useTranslations, defaultLang } from "../i18n/ui";

const langCookie = Astro.cookies.get("lang")?.value;
const lang =
    langCookie === "es" || langCookie === "en" ? langCookie : defaultLang;
const t = useTranslations(lang);
---

<AppLayout
    title={`${t("dashboard.title")} - Frontpage`}
    description="Your personal news dashboard. Stay up to date with the latest from your favorite sources."
    type="WebApplication"
    lang={lang}
>
    <div class="mt-16 md:mt-24 px-6 md:px-12 lg:px-16 mb-6">
        <h1
            class="text-7xl md:text-8xl lg:text-[7.5rem] font-serif text-text-primary tracking-tighter leading-none"
        >
            {t("dashboard.title")}
        </h1>
    </div>

    <!-- Subscriptions filter tabs -->
    <div
        class="flex items-baseline md:gap-8 pb-3 px-6 md:px-12 lg:px-16 relative w-full max-w-[1920px] mx-auto"
    >
        <div
            class="flex items-baseline gap-5 md:gap-8 overflow-x-auto flex-1 pb-1"
        >
            <span
                class="text-[10px] md:text-[11px] font-mono uppercase tracking-[0.2em] text-text-secondary opacity-70 shrink-0 mr-2 md:mr-0"
                >{t("dashboard.favorites")}</span
            >
            <div
                id="subs-tabs"
                class="flex items-baseline gap-5 md:gap-8 shrink-0"
            >
                <button
                    class="tab-btn text-xl md:text-2xl font-sans text-text-primary border-b-2 border-text-primary pb-1.5 whitespace-nowrap transition-colors"
                    data-url="all">{t("dashboard.all")}</button
                >
                <!-- Dynamic favorite tabs will be injected here -->
            </div>
        </div>

        <div class="shrink-0 ml-4 relative z-10 hidden sm:block">
            <FeedActionsMenu />
        </div>
    </div>

    <!-- Very subtle horizontal line under tabs -->
    <div class="h-px bg-text-primary/15 mb-0 max-w-[1920px] mx-auto"></div>

    <!-- 3-Column News Grid -->
    <div
        id="news-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 min-h-[400px] view-cards"
    >
        <div
            class="col-span-full flex items-center justify-center p-20 text-text-secondary opacity-50"
        >
            <div class="flex flex-col items-center gap-4">
                <div
                    class="animate-spin rounded-full h-8 w-8 border-b-2 border-text-primary"
                >
                </div>
                <p class="font-mono text-sm uppercase tracking-widest">
                    {t("dashboard.loading")}
                </p>
            </div>
        </div>
    </div>

    <!-- Empty State Container -->
    <div id="empty-state-container" class="hidden">
        <DashboardEmptyState />
    </div>

    <AddFeedModal />
    <button id="logout-btn" class="hidden">Sign Out</button>
</AppLayout>

<script>
    import { supabase } from "../lib/supabase";

    const subsContainer = document.getElementById("subs-tabs");
    const newsGrid = document.getElementById("news-grid");
    const userInfo = document.querySelector("#user-info") as HTMLElement;

    let currentSession: any = null;
    let isGuest: boolean = false;
    let subscriptions: any[] = [];
    let currentFeedUrl: string = "all";
    let viewMode: string = "cards"; // cards, list, compact
    let userBookmarks: Set<string> = new Set();

    // Curated feeds for guest mode
    const GUEST_FEEDS = [
        {
            id: "guest-1",
            is_favorite: true,
            feeds: {
                url: "https://www.theverge.com/rss/index.xml",
                title: "The Verge",
            },
        },
        {
            id: "guest-2",
            is_favorite: true,
            feeds: {
                url: "https://techcrunch.com/feed/",
                title: "TechCrunch",
            },
        },
        {
            id: "guest-3",
            is_favorite: true,
            feeds: {
                url: "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml",
                title: "NYT Top Stories",
            },
        },
    ];

    async function init() {
        const params = new URLSearchParams(window.location.search);
        isGuest =
            params.get("guest") === "true" ||
            localStorage.getItem("frontpage_guest") === "true";

        if (isGuest) {
            if (params.get("guest") === "true") {
                localStorage.setItem("frontpage_guest", "true");
                window.history.replaceState(
                    {},
                    document.title,
                    window.location.pathname,
                );
            }
            currentSession = { guest: true };
            if (userInfo) userInfo.textContent = "Guest User";
            loadSubscriptions(); // Sync call for guest
            await loadFeed("all", "All Subscriptions");
            return;
        }

        const {
            data: { session },
        } = await supabase.auth.getSession();
        if (!session) {
            window.location.href = "/login";
            return;
        }
        currentSession = session;

        if (userInfo && session.user.email)
            userInfo.textContent = session.user.email;
        // Load bookmarks in background (non-blocking)
        loadUserBookmarks().catch(() => {});
        await loadSubscriptions();
        await loadFeed("all", "All Subscriptions");
    }

    async function loadUserBookmarks() {
        if (isGuest) return;
        try {
            const res = await fetch("/api/bookmarks/list", {
                headers: {
                    Authorization: `Bearer ${currentSession.access_token}`,
                },
            });
            const data = await res.json();
            if (Array.isArray(data)) {
                userBookmarks = new Set(data.map((item: any) => item.guid));
            }
        } catch (err) {
            console.error("Failed to load bookmarks", err);
        }
    }

    async function loadSubscriptions() {
        if (isGuest) {
            const params = new URLSearchParams(window.location.search);
            if (params.get("empty") === "true") {
                subscriptions = [];
            } else {
                subscriptions = GUEST_FEEDS;
            }
            handleEmptyStateVisibility();
            renderFavoriteTabs();
            return;
        }

        try {
            const response = await fetch("/api/feeds/list", {
                headers: {
                    Authorization: `Bearer ${currentSession.access_token}`,
                },
            });
            subscriptions = await response.json();
            handleEmptyStateVisibility();
            renderFavoriteTabs();
        } catch (err) {
            console.error("Failed to load subs", err);
        }
    }

    function handleEmptyStateVisibility() {
        const emptyState = document.getElementById("empty-state-container");
        const newsSection = document.getElementById("news-grid");
        const tabsSection = document.getElementById("subs-tabs")?.parentElement;

        if (subscriptions.length === 0) {
            emptyState?.classList.remove("hidden");
            newsSection?.classList.add("hidden");
            tabsSection?.classList.add("hidden");
        } else {
            emptyState?.classList.add("hidden");
            newsSection?.classList.remove("hidden");
            tabsSection?.classList.remove("hidden");
        }
    }

    function renderFavoriteTabs() {
        if (!subsContainer) return;

        subsContainer.innerHTML = "";

        // Always recreate the All button
        const allBtn = document.createElement("button");
        allBtn.className =
            "tab-btn text-xl md:text-2xl font-sans text-text-primary border-b-2 border-text-primary pb-1.5 whitespace-nowrap transition-colors";
        allBtn.textContent = "All";
        allBtn.dataset.url = "all";
        allBtn.addEventListener("click", () => {
            loadFeed("all", "All Subscriptions");
        });
        subsContainer.appendChild(allBtn);

        // Only show top 3 favorites
        const favorites = subscriptions
            .filter((s) => s.is_favorite)
            .slice(0, 3);

        favorites.forEach((sub) => {
            const btn = document.createElement("button");
            const title = sub.custom_title || sub.feeds.title;
            btn.className =
                "tab-btn text-xl md:text-2xl font-sans text-text-secondary hover:text-text-primary border-b-2 border-transparent hover:border-text-primary/30 pb-1.5 whitespace-nowrap transition-colors relative";
            btn.textContent = title;
            btn.dataset.url = sub.feeds.url;

            btn.addEventListener("click", () => {
                loadFeed(sub.feeds.url, title, sub.id);
            });

            subsContainer.appendChild(btn);
        });
    }

    async function loadFeed(
        url: string,
        title: string,
        subscriptionId?: string,
    ) {
        if (!newsGrid) return;
        currentFeedUrl = url;
        updateTabsUI(url);

        // Mark as read if subscription ID is present
        if (subscriptionId && !isGuest) {
            try {
                fetch("/api/feeds/mark-read", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${currentSession.access_token}`,
                    },
                    body: JSON.stringify({ subscriptionId }),
                });
                window.dispatchEvent(new CustomEvent("unread-counts-changed"));
            } catch (err) {
                console.error(err);
            }
        }

        newsGrid.innerHTML = `
            <div class="col-span-full flex items-center justify-center p-20 text-text-secondary opacity-50">
                <div class="flex flex-col items-center gap-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-text-primary"></div>
                    <p class="font-mono text-sm uppercase tracking-widest">Fetching ${title}...</p>
                </div>
            </div>
        `;

        try {
            if (isGuest && url === "all") {
                // Fetch all curated feeds in parallel
                const promises = GUEST_FEEDS.map((f) =>
                    fetch(
                        `/api/feeds/content?url=${encodeURIComponent(f.feeds.url)}`,
                    ).then((r) => r.json()),
                );
                const results = await Promise.all(promises);
                let allItems: any[] = [];
                results.forEach((feed: any, index) => {
                    const items = (feed.items || []).map((item: any) => ({
                        ...item,
                        feedTitle: GUEST_FEEDS[index].feeds.title,
                        feedUrl: GUEST_FEEDS[index].feeds.url,
                    }));
                    allItems = allItems.concat(items);
                });

                // Sort by date
                allItems.sort(
                    (a, b) =>
                        new Date(b.pubDate).getTime() -
                        new Date(a.pubDate).getTime(),
                );

                renderNews({ items: allItems }, "all");
                return;
            }

            const response = await fetch(
                `/api/feeds/content?url=${encodeURIComponent(url)}`,
                {
                    headers: currentSession.access_token
                        ? {
                              Authorization: `Bearer ${currentSession.access_token}`,
                          }
                        : {},
                },
            );
            const feed = await response.json();
            renderNews(feed, url);
        } catch (err) {
            newsGrid.innerHTML = `<div class="col-span-full p-12 text-center text-red-500">Failed to load content for ${title}</div>`;
        }
    }

    function renderNews(feed: any, feedUrl: string) {
        if (!newsGrid) return;

        if (!feed.items || feed.items.length === 0) {
            newsGrid.innerHTML = `<div class="col-span-full p-20 text-center text-text-secondary">No articles found in this feed.</div>`;
            return;
        }

        newsGrid.innerHTML = feed.items
            .map((item: any) => {
                const itemFeedUrl =
                    feedUrl === "all" ? item.feedUrl || "" : feedUrl;
                const isBookmarked = userBookmarks.has(item.guid);

                return `
            <div 
                class="news-card group flex flex-col no-underline border-b-[3px] border-text-primary border-r-[3px] nth-[3n]:border-r-0 relative"
                data-guid="${item.guid}"
            >
                <a href="/preview?url=${encodeURIComponent(item.link)}&feedUrl=${encodeURIComponent(itemFeedUrl)}" class="flex flex-col flex-1 no-underline">
                    <div class="card-image-container p-5 pb-0">
                        <div class="aspect-16/10 overflow-hidden bg-bg-secondary rounded-sm">
                            <img 
                                src="${item.imageUrl || `https://placehold.co/600x375/cec7c0/2e2522?text=${encodeURIComponent(item.title)}&font=serif`}" 
                                alt="${item.title}" 
                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                loading="lazy"
                            />
                        </div>
                    </div>
                    <div class="p-6 pt-5 flex flex-col flex-1">
                        <h2 class="card-title text-xl font-serif font-bold text-text-primary leading-tight mb-6 group-hover:text-accent transition-colors duration-300 line-clamp-3">
                            ${item.title}
                        </h2>
                        <div class="card-meta flex items-center justify-between text-[10px] mt-auto border-t border-text-primary/5 pt-4">
                            <div class="flex items-center gap-3">
                                <span class="font-mono uppercase tracking-[0.2em] text-text-primary px-2 py-0.5 bg-text-primary/5 rounded-sm">${item.feedTitle || feed.title || "Feed"}</span>
                                <time class="font-sans text-text-secondary opacity-60">${new Date(item.pubDate).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }).toUpperCase()}</time>
                            </div>
                        </div>
                    </div>
                </a>
                
                <!-- Action buttons -->
                <div class="card-actions flex flex-col absolute top-4 right-4 gap-1 z-10">
                    <a href="${item.link}" target="_blank" rel="noopener" class="action-btn w-7 h-7 flex items-center justify-center rounded-full border border-text-secondary/30 text-text-secondary hover:border-text-primary hover:text-text-primary transition-colors text-xs bg-bg-primary/80 backdrop-blur-sm no-underline">â†—</a>
                    <button 
                        class="bookmark-btn action-btn w-7 h-7 flex items-center justify-center rounded-full bg-bg-primary/80 backdrop-blur-sm border border-text-primary/10 text-text-secondary hover:text-text-primary hover:border-text-primary/30 transition-all"
                        title="${isBookmarked ? "Remove bookmark" : "Bookmark for later"}"
                        data-item='${JSON.stringify(item).replace(/'/g, "&apos;")}'
                        data-feed-url="${itemFeedUrl}"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="${isBookmarked ? "currentColor" : "none"}" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/>
                        </svg>
                    </button>
                </div>
            </div>
        `;
            })
            .join("");

        // Add event listeners for bookmark buttons
        document.querySelectorAll(".bookmark-btn").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (isGuest) {
                    alert(
                        "Please sign in or create an account to bookmark articles.",
                    );
                    return;
                }

                const b = e.currentTarget as HTMLButtonElement;
                const itemData = JSON.parse(b.dataset.item || "{}");
                const feedUrl = b.dataset.feedUrl;

                // Optimistic UI
                const svg = b.querySelector("svg");
                const isCurrentlySaved = svg?.getAttribute("fill") !== "none";
                if (svg)
                    svg.setAttribute(
                        "fill",
                        isCurrentlySaved ? "none" : "currentColor",
                    );

                try {
                    const res = await fetch("/api/bookmarks/toggle", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${currentSession.access_token}`,
                        },
                        body: JSON.stringify({ item: itemData, feedUrl }),
                    });
                    const result = await res.json();

                    if (result.is_saved) {
                        userBookmarks.add(itemData.guid);
                        if (svg) svg.setAttribute("fill", "currentColor");
                        b.title = "Remove bookmark";
                    } else {
                        userBookmarks.delete(itemData.guid);
                        if (svg) svg.setAttribute("fill", "none");
                        b.title = "Bookmark for later";
                    }
                } catch (err) {
                    console.error("Bookmark toggle failed", err);
                    // Rollback
                    if (svg)
                        svg.setAttribute(
                            "fill",
                            isCurrentlySaved ? "currentColor" : "none",
                        );
                }
            });
        });
    }

    function updateTabsUI(activeUrl: string) {
        const btns = document.querySelectorAll(".tab-btn");
        btns.forEach((btn) => {
            if ((btn as HTMLElement).dataset.url === activeUrl) {
                btn.classList.remove(
                    "text-text-secondary",
                    "border-transparent",
                    "hover:border-text-primary/30",
                );
                btn.classList.add("text-text-primary", "border-text-primary");
            } else {
                btn.classList.remove(
                    "text-text-primary",
                    "border-text-primary",
                );
                btn.classList.add(
                    "text-text-secondary",
                    "border-transparent",
                    "hover:border-text-primary/30",
                );
            }
        });
    }

    // --- Event Listeners ---

    window.addEventListener("feed-added", () => {
        loadSubscriptions();
    });

    window.addEventListener("feed-favorite-toggled", () => {
        loadSubscriptions();
    });

    window.addEventListener("select-feed", (e: any) => {
        const { url, title, subscriptionId } = e.detail;
        loadFeed(url, title, subscriptionId);
    });

    window.addEventListener("feed-action", (e: any) => {
        const { action } = e.detail;
        if (action === "refresh") {
            loadFeed(currentFeedUrl, "Refreshing...");
        } else if (action.startsWith("view-")) {
            const mode = action.replace("view-", "");
            setViewMode(mode);
        }
    });

    function setViewMode(mode: string) {
        viewMode = mode;
        newsGrid?.classList.remove("view-cards", "view-list", "view-compact");
        newsGrid?.classList.add(`view-${mode}`);

        if (mode === "list") {
            newsGrid?.classList.remove(
                "grid-cols-1",
                "md:grid-cols-2",
                "lg:grid-cols-3",
            );
            newsGrid?.classList.add("grid-cols-1");
        } else if (mode === "cards") {
            newsGrid?.classList.add(
                "grid-cols-1",
                "md:grid-cols-2",
                "lg:grid-cols-3",
            );
            newsGrid?.classList.remove("grid-cols-1");
        }
    }

    // Start
    init();
</script>

<style is:global>
    /* View Mode: List */
    .view-list {
        display: flex !important;
        flex-direction: column !important;
        grid-template-columns: none !important;
    }
    .view-list .news-card {
        flex-direction: row !important;
        min-height: 100px;
        max-height: 120px;
        border-right: none !important;
        overflow: hidden;
    }
    .view-list .news-card > a {
        flex-direction: row !important;
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }
    .view-list .card-image-container {
        width: 160px;
        min-width: 160px;
        max-width: 160px;
        padding: 10px !important;
        flex-shrink: 0;
    }
    .view-list .card-image-container > div {
        aspect-ratio: auto !important;
        height: 100%;
    }
    .view-list .news-card > a > div:last-child {
        flex: 1;
        min-width: 0;
        padding: 10px 12px !important;
        overflow: hidden;
    }
    .view-list .card-title {
        font-size: 0.95rem;
        margin-bottom: 4px !important;
        -webkit-line-clamp: 2;
    }
    /* Actions in list: flex row, positioned at end of card */
    .view-list .card-actions {
        position: relative !important;
        top: auto !important;
        right: auto !important;
        flex-direction: row !important;
        align-items: center;
        align-self: center;
        gap: 10px;
        padding-right: 12px;
        margin-left: 12px;
        flex-shrink: 0;
    }

    /* View Mode: Compact */
    .view-compact {
        display: flex !important;
        flex-direction: column !important;
        grid-template-columns: none !important;
    }
    .view-compact .news-card {
        flex-direction: row !important;
        align-items: center;
        border-right: none !important;
        padding: 6px 16px;
        min-height: auto;
    }
    .view-compact .news-card > a {
        flex-direction: row !important;
        flex: 1;
        min-width: 0;
        align-items: center;
        gap: 12px;
    }
    .view-compact .card-image-container {
        display: none !important;
    }
    .view-compact .news-card > a > div:last-child {
        flex: 1;
        min-width: 0;
        padding: 4px 0 !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: center;
        gap: 12px;
    }
    .view-compact .card-title {
        font-size: 0.875rem;
        margin-bottom: 0 !important;
        flex: 1;
        min-width: 0;
        -webkit-line-clamp: 1;
    }
    .view-compact .card-meta {
        flex-shrink: 0;
        margin-top: 0 !important;
    }
    /* Actions in compact: flex row, positioned at end of card */
    .view-compact .card-actions {
        position: relative !important;
        top: auto !important;
        right: auto !important;
        flex-direction: row !important;
        align-items: center;
        align-self: center;
        gap: 10px;
        padding-right: 8px;
        margin-left: 16px;
        flex-shrink: 0;
    }
</style>
