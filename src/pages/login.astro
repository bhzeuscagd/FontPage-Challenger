---
import Layout from "../layouts/Layout.astro";
import { useTranslations, defaultLang } from "../i18n/ui";

const langCookie = Astro.cookies.get("lang")?.value;
const lang =
    langCookie === "es" || langCookie === "en" ? langCookie : defaultLang;
const t = useTranslations(lang);

const initialMode = Astro.url.pathname.includes("register")
    ? "register"
    : "login";
---

<Layout title="Auth - Frontpage">
    <section
        class="relative flex min-h-screen overflow-hidden bg-bg-primary"
        id="auth-container"
    >
        <!-- OVERLAY PANEL (the sliding door) -->
        <div
            id="overlay-panel"
            class="absolute top-0 left-0 w-1/2 h-full z-20 flex flex-col items-center justify-center p-16 text-center transition-transform duration-700 ease-[cubic-bezier(0.76,0,0.24,1)] bg-bg-primary"
        >
            <!-- Login welcome (visible when mode=login) -->
            <div
                id="overlay-login"
                class="flex flex-col items-start text-start gap-4 transition-opacity duration-500"
            >
                <h2 class="font-serif text-2xl text-text-primary">
                    {t("auth.login.title")}
                </h2>
                <h1
                    class="font-mono font-bold text-7xl leading-none text-text-primary"
                >
                    {t("auth.login.welcome_1")}<br />{t("auth.login.welcome_2")}
                </h1>
                <p class="text-text-secondary max-w-xs">
                    {t("auth.login.subtitle")}
                </p>
            </div>

            <!-- Register welcome (visible when mode=register) -->
            <div
                id="overlay-register"
                class="absolute inset-0 flex flex-col items-end text-end justify-center gap-4 p-16 transition-opacity duration-500 opacity-0 pointer-events-none"
            >
                <h2 class="font-serif text-2xl text-text-primary">
                    {t("auth.register.title")}
                </h2>
                <h1
                    class="font-mono font-bold text-7xl leading-none text-text-primary"
                >
                    {t("auth.register.welcome_1")}<br />{
                        t("auth.register.welcome_2")
                    }<br />{t("auth.register.welcome_3")}
                </h1>
                <p class="text-text-secondary max-w-xs">
                    {t("auth.register.subtitle")}
                </p>
            </div>
        </div>

        <!-- LOGIN FORM (sits on the right half) -->
        <div
            id="login-panel"
            class="absolute top-0 right-0 w-1/2 h-full flex flex-col justify-center px-6 py-12 lg:px-8 transition-opacity duration-500"
        >
            <a
                href="/"
                class="absolute top-6 right-6 text-sm font-semibold text-text-secondary hover:text-text-primary transition-colors no-underline flex items-center gap-1 z-30"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="w-4 h-4"><path d="m15 18-6-6 6-6"></path></svg
                >
                {t("nav.home")}
            </a>
            <div class="sm:mx-auto sm:w-full sm:max-w-sm">
                <h2
                    class="text-center text-2xl font-bold tracking-tight text-text-primary"
                >
                    {t("auth.form.login_header")}
                </h2>
            </div>
            <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-sm">
                <form class="flex flex-col gap-6" id="login-form">
                    <div>
                        <label
                            for="login-email"
                            class="block text-sm font-medium text-text-primary"
                            >{t("auth.form.email")}</label
                        >
                        <div class="mt-2">
                            <input
                                id="login-email"
                                name="email"
                                type="email"
                                autocomplete="email"
                                required
                                class="block w-full rounded-md border border-border bg-bg-primary px-2 py-1.5 text-sm text-text-primary focus:outline-2 focus:outline-text-primary"
                            />
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between">
                            <label
                                for="login-password"
                                class="block text-sm font-medium text-text-primary"
                                >{t("auth.form.password")}</label
                            >
                            <a
                                href="#"
                                class="text-sm font-semibold text-text-primary no-underline hover:opacity-80"
                                >{t("auth.form.forgot")}</a
                            >
                        </div>
                        <div class="mt-2">
                            <input
                                id="login-password"
                                name="password"
                                type="password"
                                autocomplete="current-password"
                                required
                                class="block w-full rounded-md border border-border bg-bg-primary px-2 py-1.5 text-sm text-text-primary focus:outline-2 focus:outline-text-primary"
                            />
                        </div>
                    </div>
                    <div>
                        <button
                            type="submit"
                            class="flex w-full justify-center rounded-md bg-text-primary px-3 py-1.5 text-sm font-semibold text-bg-primary shadow-sm cursor-pointer hover:opacity-90"
                        >
                            {t("auth.form.signin_btn")}
                        </button>
                    </div>
                </form>
                <p class="mt-10 text-center text-sm text-text-secondary">
                    {t("auth.form.not_member")}
                    <button
                        id="go-register"
                        class="font-semibold text-text-primary cursor-pointer bg-transparent border-none hover:opacity-80"
                    >
                        {t("auth.form.start_trial")}
                    </button>
                </p>
                <div
                    id="login-error"
                    class="text-red-500 text-sm mt-4 text-center hidden"
                >
                </div>
            </div>
        </div>

        <!-- REGISTER FORM (sits on the left half, hidden initially) -->
        <div
            id="register-panel"
            class="absolute top-0 left-0 w-1/2 h-full flex flex-col justify-center px-6 py-12 lg:px-8 transition-opacity duration-500 opacity-0 pointer-events-none"
        >
            <a
                href="/"
                class="absolute top-6 left-6 text-sm font-semibold text-text-secondary hover:text-text-primary transition-colors no-underline flex items-center gap-1 z-30"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="w-4 h-4"><path d="m15 18-6-6 6-6"></path></svg
                >
                {t("nav.home")}
            </a>
            <div class="sm:mx-auto sm:w-full sm:max-w-sm">
                <h2
                    class="text-center text-2xl font-bold tracking-tight text-text-primary"
                >
                    {t("auth.form.register_header")}
                </h2>
            </div>
            <div class="mt-10 sm:mx-auto sm:w-full sm:max-w-sm">
                <form class="flex flex-col gap-6" id="register-form">
                    <div>
                        <label
                            for="reg-email"
                            class="block text-sm font-medium text-text-primary"
                            >{t("auth.form.email")}</label
                        >
                        <div class="mt-2">
                            <input
                                id="reg-email"
                                name="email"
                                type="email"
                                autocomplete="email"
                                required
                                class="block w-full rounded-md border border-border bg-bg-primary px-2 py-1.5 text-sm text-text-primary focus:outline-2 focus:outline-text-primary"
                            />
                        </div>
                    </div>
                    <div>
                        <label
                            for="reg-password"
                            class="block text-sm font-medium text-text-primary"
                            >{t("auth.form.password")}</label
                        >
                        <div class="mt-2">
                            <input
                                id="reg-password"
                                name="password"
                                type="password"
                                autocomplete="new-password"
                                required
                                class="block w-full rounded-md border border-border bg-bg-primary px-2 py-1.5 text-sm text-text-primary focus:outline-2 focus:outline-text-primary"
                            />
                        </div>
                    </div>
                    <div>
                        <button
                            type="submit"
                            class="flex w-full justify-center rounded-md bg-text-primary px-3 py-1.5 text-sm font-semibold text-bg-primary shadow-sm cursor-pointer hover:opacity-90"
                        >
                            {t("auth.form.signup_btn")}
                        </button>
                    </div>
                </form>
                <p class="mt-10 text-center text-sm text-text-secondary">
                    {t("auth.form.already_member")}
                    <button
                        id="go-login"
                        class="font-semibold text-text-primary cursor-pointer bg-transparent border-none hover:opacity-80"
                    >
                        {t("auth.form.signin_link")}
                    </button>
                </p>
                <div
                    id="register-error"
                    class="text-red-500 text-sm mt-4 text-center hidden"
                >
                </div>
            </div>
        </div>
    </section>
</Layout>

<script define:vars={{ initialMode }}>
    window.__authInitialMode = initialMode;
</script>

<script>
    import { supabase } from "../lib/supabase";

    const overlay = document.getElementById("overlay-panel")!;
    const overlayLogin = document.getElementById("overlay-login")!;
    const overlayRegister = document.getElementById("overlay-register")!;
    const loginPanel = document.getElementById("login-panel")!;
    const registerPanel = document.getElementById("register-panel")!;
    const goRegisterBtn = document.getElementById("go-register")!;
    const goLoginBtn = document.getElementById("go-login")!;

    let currentMode = (window as any).__authInitialMode || "login";

    // Auto-redirect if already logged in
    supabase.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            window.location.href = "/dashboard";
        }
    });

    function setMode(mode: string) {
        currentMode = mode;

        if (mode === "register") {
            // Slide overlay to the right
            overlay.style.transform = "translateX(100%)";

            // Swap overlay text
            overlayLogin.style.opacity = "0";
            overlayLogin.style.pointerEvents = "none";
            overlayRegister.style.opacity = "1";
            overlayRegister.style.pointerEvents = "auto";

            // Show register form (left), hide login form (right)
            registerPanel.style.opacity = "1";
            registerPanel.style.pointerEvents = "auto";
            loginPanel.style.opacity = "0";
            loginPanel.style.pointerEvents = "none";

            history.replaceState(null, "", "/register");
            document.title = "Sign Up - Frontpage";
        } else {
            // Slide overlay to the left (default)
            overlay.style.transform = "translateX(0)";

            // Swap overlay text
            overlayLogin.style.opacity = "1";
            overlayLogin.style.pointerEvents = "auto";
            overlayRegister.style.opacity = "0";
            overlayRegister.style.pointerEvents = "none";

            // Show login form (right), hide register form (left)
            loginPanel.style.opacity = "1";
            loginPanel.style.pointerEvents = "auto";
            registerPanel.style.opacity = "0";
            registerPanel.style.pointerEvents = "none";

            history.replaceState(null, "", "/login");
            document.title = "Sign In - Frontpage";
        }
    }

    // Initialize
    if (currentMode === "register") {
        overlay.style.transition = "none";
        setMode("register");
        // Re-enable transition after initial positioning
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                overlay.style.transition = "";
            });
        });
    }

    goRegisterBtn.addEventListener("click", () => setMode("register"));
    goLoginBtn.addEventListener("click", () => setMode("login"));

    // Login form
    const loginForm = document.querySelector("#login-form") as HTMLFormElement;
    const loginError = document.querySelector("#login-error") as HTMLElement;

    loginForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(loginForm);
        const email = formData.get("email") as string;
        const password = formData.get("password") as string;

        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
        });

        if (error) {
            loginError.textContent = error.message;
            loginError.classList.remove("hidden");
        } else {
            window.location.href = "/dashboard";
        }
    });

    // Register form
    const registerForm = document.querySelector(
        "#register-form",
    ) as HTMLFormElement;
    const registerError = document.querySelector(
        "#register-error",
    ) as HTMLElement;

    registerForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(registerForm);
        const email = formData.get("email") as string;
        const password = formData.get("password") as string;

        const { data, error } = await supabase.auth.signUp({ email, password });

        if (error) {
            registerError.textContent = error.message;
            registerError.classList.remove("hidden");
        } else {
            if (data.session) {
                window.location.href = "/dashboard";
            } else {
                registerError.textContent =
                    "Check your email for the confirmation link.";
                registerError.classList.remove("hidden", "text-red-500");
                registerError.classList.add("text-green-600");
            }
        }
    });
</script>
