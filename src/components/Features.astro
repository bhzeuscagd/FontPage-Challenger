---
import { useTranslations, defaultLang } from "../i18n/ui";

const langCookie = Astro.cookies.get("lang")?.value;
const lang =
    langCookie === "es" || langCookie === "en" ? langCookie : defaultLang;
const t = useTranslations(lang);
---

<div class="features-shutter-wrapper relative h-[300vh] z-30">
    <!-- Sticky Viewport -->
    <div
        class="sticky-viewport sticky top-0 h-screen w-full overflow-hidden bg-bg-primary"
    >
        <!-- REVEALED CONTENT (Becomes visible as shutter slides up) -->
        <div
            class="revealed-content absolute inset-0 z-10 flex items-center justify-center"
        >
            <div
                class="grid grid-cols-1 md:grid-cols-3 w-full h-full max-w-none bg-bg-primary"
            >
                <div
                    class="feature-col relative p-8 md:p-16 lg:p-20 flex flex-col justify-end border-b-[3px] md:border-b-0 md:border-r-[3px] border-text-primary hover:bg-text-primary/2 transition-colors min-h-[33vh] md:min-h-0 container-snap"
                >
                    <div
                        class="mt-auto flex flex-col justify-end w-full max-w-[90%] md:max-w-full mx-auto md:mx-0"
                    >
                        <span
                            class="font-serif text-2xl md:text-4xl text-text-primary block mb-2"
                            >I.</span
                        >
                        <h3
                            class="font-serif text-3xl md:text-5xl lg:text-6xl text-text-primary mb-3 md:mb-6 leading-tight wrap-break-word"
                        >
                            {t("features.1.title")}
                        </h3>
                        <p
                            class="text-text-secondary leading-relaxed text-base md:text-xl max-w-sm"
                        >
                            {t("features.1.desc")}
                        </p>
                    </div>
                </div>

                <!-- Feature II -->
                <div
                    class="feature-col relative p-8 md:p-16 lg:p-20 flex flex-col justify-end border-b-[3px] md:border-b-0 md:border-r-[3px] border-text-primary hover:bg-text-primary/2 transition-colors min-h-[33vh] md:min-h-0 container-snap"
                >
                    <div
                        class="mt-auto flex flex-col justify-end w-full max-w-[90%] md:max-w-full mx-auto md:mx-0"
                    >
                        <span
                            class="font-serif text-2xl md:text-4xl text-text-primary block mb-2"
                            >II.</span
                        >
                        <h3
                            class="font-serif text-3xl md:text-5xl lg:text-6xl text-text-primary mb-3 md:mb-6 leading-tight wrap-break-word"
                        >
                            {t("features.2.title")}
                        </h3>
                        <p
                            class="text-text-secondary leading-relaxed text-base md:text-xl max-w-sm"
                        >
                            {t("features.2.desc")}
                        </p>
                    </div>
                </div>

                <!-- Feature III -->
                <div
                    class="feature-col relative p-8 md:p-16 lg:p-20 flex flex-col justify-end hover:bg-text-primary/2 transition-colors min-h-[33vh] md:min-h-0 container-snap"
                >
                    <div
                        class="mt-auto flex flex-col justify-end w-full max-w-[90%] md:max-w-full mx-auto md:mx-0"
                    >
                        <span
                            class="font-serif text-2xl md:text-4xl text-text-primary block mb-2"
                            >III.</span
                        >
                        <h3
                            class="font-serif text-3xl md:text-5xl lg:text-6xl text-text-primary mb-3 md:mb-6 leading-tight wrap-break-word"
                        >
                            {t("features.3.title")}
                        </h3>
                        <p
                            class="text-text-secondary leading-relaxed text-base md:text-xl max-w-sm"
                        >
                            {t("features.3.desc")}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- THE SHUTTER (Slides UP) -->
        <div
            class="shutter-panel absolute inset-0 z-20 bg-bg-primary flex flex-col items-center justify-center p-8 will-change-transform"
        >
            <div class="text-center">
                <p
                    class="font-mono text-xs md:text-sm tracking-[0.4em] text-text-secondary uppercase mb-8 opacity-60"
                >
                    {t("features.shutter.pre")}
                </p>
                <h2
                    class="font-serif text-5xl md:text-7xl lg:text-9xl text-text-primary leading-[0.9] tracking-tighter max-w-5xl"
                >
                    <span set:html={t("features.shutter.title")} />
                </h2>
            </div>

            <!-- Horizontal line at bottom of shutter to signify it's a panel -->
            <div
                class="absolute bottom-0 left-0 w-full h-px bg-text-primary/20"
            >
            </div>
        </div>
    </div>
</div>

<script>
    function initShutterReveal() {
        const wrapper = document.querySelector(
            ".features-shutter-wrapper",
        ) as HTMLElement;
        const shutter = document.querySelector(".shutter-panel") as HTMLElement;
        const content = document.querySelector(
            ".revealed-content",
        ) as HTMLElement;
        const featureCols = document.querySelectorAll(".feature-col");

        if (!wrapper || !shutter || !content) return;

        function updateShutter() {
            const rect = wrapper.getBoundingClientRect();
            const scrollPos = window.scrollY;
            const start = rect.top + scrollPos;
            const scrollDistance = rect.height - window.innerHeight;

            // Normalize progress: 0 (closed) to 1 (fully open)
            let progress = Math.max(
                0,
                Math.min(1, (scrollPos - start) / scrollDistance),
            );

            // Shutter sliding UP
            shutter.style.transform = `translateY(-${progress * 100}%)`;

            // Content enters with a subtle scale and opacity
            const contentProgress = Math.max(
                0,
                Math.min(1, (progress - 0.1) / 0.9),
            );
            content.style.opacity = (contentProgress * 1.5).toString(); // Faster fade in
            content.style.transform = `scale(${0.98 + contentProgress * 0.02})`;

            // STAGGERED COLUMNS REVEAL
            featureCols.forEach((col, index) => {
                const c = col as HTMLElement;
                // Stagger: col 0 starts at 0.2, col 1 at 0.35, col 2 at 0.5
                const colStart = 0.2 + index * 0.15;
                const colProgress = Math.max(
                    0,
                    Math.min(1, (progress - colStart) / 0.4),
                );

                c.style.opacity = colProgress.toString();
                c.style.transform = `translateY(${(1 - colProgress) * 40}px)`;
            });

            // Allow pointer events only when shutter starts opening
            if (progress > 0.05) {
                content.style.pointerEvents = "auto";
            } else {
                content.style.pointerEvents = "none";
            }

            // Optimization: hide shutter when fully open
            if (progress >= 1) {
                shutter.style.visibility = "hidden";
            } else {
                shutter.style.visibility = "visible";
            }
        }

        window.addEventListener("scroll", updateShutter, { passive: true });
        updateShutter(); // Initial call
    }

    // Initialize on page load
    initShutterReveal();

    // Handle Astro view transitions
    document.addEventListener("astro:page-load", initShutterReveal);
</script>

<style>
    .revealed-content {
        transition:
            opacity 0.05s linear,
            transform 0.05s linear;
        will-change: opacity, transform;
    }
</style>
